<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake Battle Royale</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: Arial, sans-serif;
    }
    html { height: 100%; }
    #gameContainer {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gameCanvas {
      background: #1a1a2e;
      border: 5px solid #fff;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      max-width: 100%;
      max-height: 100%;
    }
    .hud {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.95);
      padding: 20px;
      border-radius: 15px;
      color: #fff;
      min-width: 200px;
      border: 3px solid #00ff88;
    }
    .hud-title {
      font-size: 20px;
      color: #00ff88;
      margin-bottom: 5px;
      text-align: center;
    }
    .hud-email {
      font-size: 12px;
      color: #888;
      margin-bottom: 15px;
      text-align: center;
      word-break: break-all;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 16px;
      padding: 8px;
      background: rgba(0, 255, 136, 0.1);
      border-radius: 8px;
    }
    .stat-label { color: #00ff88; }
    .stat-value { color: #fff; font-weight: bold; }
    .leaderboard {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.95);
      padding: 20px;
      border-radius: 15px;
      color: #fff;
      min-width: 250px;
      max-height: 400px;
      overflow-y: auto;
      border: 3px solid #ff6b6b;
    }
    .leaderboard-title {
      font-size: 18px;
      color: #ff6b6b;
      margin-bottom: 15px;
      text-align: center;
    }
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 10px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border-left: 4px solid #ff6b6b;
    }
    .leaderboard-item.you {
      background: rgba(0, 255, 136, 0.2);
      border-left-color: #00ff88;
    }
    .rank { font-size: 18px; font-weight: bold; color: #ffd700; min-width: 30px; }
    .player-info { flex: 1; margin: 0 10px; }
    .player-name { font-size: 14px; color: #fff; }
    .player-score { font-size: 16px; font-weight: bold; color: #00ff88; }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px 20px;
      border-radius: 15px;
      color: #fff;
      border: 3px solid #4ecdc4;
    }
    .controls-title { font-size: 16px; color: #4ecdc4; margin-bottom: 10px; }
    .control-item { font-size: 13px; margin: 5px 0; color: #ccc; }
    .touch-controls {
      position: fixed;
      bottom: 80px;
      right: 20px;
      display: none;
      z-index: 1000;
    }
    @media (max-width: 768px) {
      .touch-controls { display: block; }
    }
    .dpad { position: relative; width: 220px; height: 220px; }
    .arrow-btn {
      position: absolute;
      width: 70px;
      height: 70px;
      background: rgba(0, 255, 136, 0.9);
      border: 4px solid #00ff88;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #000;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
    }
    .arrow-btn:active {
      background: rgba(0, 255, 136, 1);
      transform: scale(0.92);
    }
    .arrow-up { top: 0; left: 75px; }
    .arrow-down { bottom: 0; left: 75px; }
    .arrow-left { top: 75px; left: 0; }
    .arrow-right { top: 75px; right: 0; }
    .game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      border: 5px solid #ff6b6b;
      display: none;
      z-index: 1000;
    }
    .game-over.show { display: block; }
    .game-over-title { font-size: 48px; color: #ff6b6b; margin-bottom: 20px; }
    .game-over-stats { font-size: 24px; color: #fff; margin: 15px 0; }
    .game-over-rank { font-size: 32px; color: #ffd700; margin: 20px 0; }
    .restart-btn {
      margin-top: 30px;
      padding: 15px 40px;
      font-size: 20px;
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .restart-btn:hover { transform: translateY(-3px); }
    .name-input-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .name-input-box {
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      border: 5px solid #fff;
      max-width: 90%;
    }
    .name-input-title { font-size: 36px; color: #fff; margin-bottom: 20px; }
    .name-input-subtitle { font-size: 18px; color: #ddd; margin-bottom: 30px; }
    .name-input {
      width: 300px;
      max-width: 100%;
      padding: 15px;
      font-size: 20px;
      border: 3px solid #00ff88;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      text-align: center;
      margin-bottom: 15px;
      outline: none;
    }
    .name-input:focus { border-color: #fff; }
    .start-btn {
      padding: 15px 50px;
      font-size: 24px;
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .start-btn:hover { transform: translateY(-3px); }
    .player-counter {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      color: #fff;
      font-size: 18px;
      border: 3px solid #ffd700;
    }
    .player-counter-value { color: #ffd700; font-weight: bold; font-size: 24px; }
    .kill-feed {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 500;
    }
    .kill-message {
      background: rgba(255, 107, 107, 0.9);
      color: #fff;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      animation: killPop 2s ease forwards;
    }
    @keyframes killPop {
      0% { transform: scale(0); opacity: 0; }
      20% { transform: scale(1.2); opacity: 1; }
      80% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }
    .lives-display { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
    .heart { color: #ff6b6b; font-size: 18px; }
    .logout-btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 30px;
      font-size: 16px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      border: 3px solid #fff;
      z-index: 100;
    }
    .logout-btn:hover { transform: translateX(-50%) translateY(-3px); }
    .login-mode-btn {
      margin-top: 15px;
      padding: 12px 30px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 3px solid #fff;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }
    .login-mode-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
    .error-message {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      border: 2px solid #ff6b6b;
      display: none;
    }
    .success-message {
      background: rgba(0, 255, 136, 0.2);
      color: #00ff88;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      border: 2px solid #00ff88;
      display: none;
    }
    .input-label {
      display: block;
      text-align: left;
      color: #ddd;
      font-size: 14px;
      margin-bottom: 5px;
      margin-top: 10px;
    }
    .store-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.98);
      padding: 40px;
      border-radius: 20px;
      border: 5px solid #ffd700;
      display: none;
      z-index: 3000;
      min-width: 400px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    .store-modal.show { display: block; }
    .store-title { font-size: 36px; color: #ffd700; margin-bottom: 20px; text-align: center; }
    .store-item {
      background: rgba(255, 215, 0, 0.1);
      padding: 20px;
      margin: 15px 0;
      border-radius: 15px;
      border: 3px solid rgba(255, 215, 0, 0.5);
      text-align: center;
    }
    .store-item-title { font-size: 24px; color: #fff; margin-bottom: 10px; }
    .store-item-desc { font-size: 16px; color: #ccc; margin-bottom: 15px; }
    .store-item-price { font-size: 28px; color: #ffd700; font-weight: bold; margin-bottom: 15px; }
    .buy-btn {
      padding: 12px 40px;
      font-size: 18px;
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .buy-btn:hover { transform: translateY(-3px); }
    .close-store-btn {
      margin-top: 20px;
      padding: 12px 30px;
      font-size: 16px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }
    .admin-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.98);
      padding: 40px;
      border-radius: 20px;
      border: 5px solid #a29bfe;
      display: none;
      z-index: 3000;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    .admin-panel.show { display: block; }
    .admin-title { font-size: 32px; color: #a29bfe; margin-bottom: 20px; text-align: center; }
    .admin-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(162, 155, 254, 0.1);
      border-radius: 10px;
      border: 2px solid rgba(162, 155, 254, 0.3);
    }
    .admin-section-title { font-size: 18px; color: #a29bfe; margin-bottom: 15px; font-weight: bold; }
    .admin-player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 8px 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      color: #fff;
      gap: 10px;
    }
    .admin-player-info { flex: 1; min-width: 0; }
    .admin-player-name { font-weight: bold; color: #00ff88; margin-bottom: 5px; word-break: break-word; }
    .admin-player-stats { font-size: 12px; color: #ccc; }
    .admin-actions { display: flex; gap: 5px; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end; }
    .admin-action-btn {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      white-space: nowrap;
    }
    .add-life-btn { background: #00ff88; color: #000; }
    .add-life-btn:hover { background: #00cc6a; transform: scale(1.05); }
    .remove-life-btn { background: #ffd700; color: #000; }
    .remove-life-btn:hover { background: #ffed4e; transform: scale(1.05); }
    .kick-btn { background: #ff6b6b; color: #fff; }
    .kick-btn:hover { background: #ff5252; transform: scale(1.05); }
    .close-admin-btn {
      margin-top: 20px;
      padding: 12px 30px;
      font-size: 16px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }
    .no-players-message {
      text-align: center;
      color: #ccc;
      padding: 20px;
      font-size: 14px;
      font-style: italic;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="gameContainer">
   <div class="name-input-overlay" id="nameInputOverlay">
    <div class="name-input-box">
     <div class="name-input-title">
      üêç SNAKE BATTLE ROYALE üêç
     </div>
     <div class="name-input-subtitle" id="authSubtitle">
      Crie sua conta ou fa√ßa login!
     </div><label class="input-label" for="nameInput">Nome do Jogador</label> <input type="text" id="nameInput" class="name-input" placeholder="Seu nome" maxlength="15"> <label class="input-label" for="emailInput">Email</label> <input type="email" id="emailInput" class="name-input" placeholder="seu@email.com"> <label class="input-label" for="passwordInput">Senha</label> <input type="password" id="passwordInput" class="name-input" placeholder="Sua senha">
     <div class="error-message" id="authError"></div>
     <div class="success-message" id="authSuccess"></div><br><button class="start-btn" id="startBtn">CRIAR CONTA E JOGAR</button> <button class="login-mode-btn" id="loginModeBtn">J√Å TENHO CONTA - FAZER LOGIN</button> <button class="login-mode-btn" id="storeBtn" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; margin-top: 10px;">üõí LOJA DE VIDAS</button> <button class="login-mode-btn" id="adminBtn" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); margin-top: 5px;">üëë ADMIN</button>
    </div>
   </div>
   <canvas id="gameCanvas" width="360" height="640"></canvas>
   <div class="hud">
    <div class="hud-title" id="playerNameDisplay">
     ‚öîÔ∏è SEU STATUS
    </div>
    <div class="hud-email" id="playerEmailDisplay"></div>
    <div class="stat">
     <span class="stat-label">üêç Tamanho:</span><span class="stat-value" id="length">3</span>
    </div>
    <div class="stat">
     <span class="stat-label">üíÄ Kills:</span><span class="stat-value" id="kills">0</span>
    </div>
    <div class="stat">
     <span class="stat-label">‚≠ê Pontos:</span><span class="stat-value" id="score">0</span>
    </div>
    <div class="stat">
     <span class="stat-label">üèÜ Rank:</span><span class="stat-value" id="rank">#-</span>
    </div>
    <div class="stat">
     <span class="stat-label">‚ù§Ô∏è Vidas:</span>
     <div class="lives-display" id="livesDisplay">
      <span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span>
     </div>
    </div>
   </div>
   <div class="leaderboard">
    <div class="leaderboard-title">
     üèÜ TOP JOGADORES
    </div>
    <div id="leaderboardList"></div>
   </div>
   <div class="controls">
    <div class="controls-title">
     üéÆ CONTROLES
    </div>
    <div class="control-item">
     ‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è Setas do Teclado
    </div>
    <div class="control-item">
     üì± Bot√µes de Seta (Mobile)
    </div>
    <div class="control-item">
     üí• Coma outros para crescer!
    </div>
   </div><button class="logout-btn" id="logoutBtn">üö™ SAIR E SALVAR</button>
   <div class="player-counter">
    üéØ Jogadores Vivos: <span class="player-counter-value" id="playersAlive">0</span>
   </div>
   <div class="touch-controls">
    <div class="dpad">
     <div class="arrow-btn arrow-up" id="arrowUp">
      ‚¨ÜÔ∏è
     </div>
     <div class="arrow-btn arrow-down" id="arrowDown">
      ‚¨áÔ∏è
     </div>
     <div class="arrow-btn arrow-left" id="arrowLeft">
      ‚¨ÖÔ∏è
     </div>
     <div class="arrow-btn arrow-right" id="arrowRight">
      ‚û°Ô∏è
     </div>
    </div>
   </div>
   <div class="kill-feed" id="killFeed"></div>
   <div class="game-over" id="gameOver">
    <div class="game-over-title">
     üíÄ VOC√ä MORREU!
    </div>
    <div class="game-over-stats">
     üêç Tamanho Final: <span id="finalLength">0</span>
    </div>
    <div class="game-over-stats">
     üíÄ Kills: <span id="finalKills">0</span>
    </div>
    <div class="game-over-stats">
     ‚≠ê Pontua√ß√£o: <span id="finalScore">0</span>
    </div>
    <div class="game-over-rank">
     üèÜ Posi√ß√£o: <span id="finalRank">#-</span>
    </div>
    <div class="game-over-stats" style="color: #ff6b6b;">
     ‚ù§Ô∏è Vidas Restantes: <span id="livesRemaining">0</span>
    </div><button class="restart-btn" id="restartBtn">JOGAR NOVAMENTE</button>
   </div>
   <div class="store-modal" id="storeModal">
    <div class="store-title">
     üõí LOJA DE VIDAS
    </div>
    <div class="store-item">
     <div class="store-item-title">
      ‚ù§Ô∏è 1 Vida Extra
     </div>
     <div class="store-item-desc">
      Continue jogando mesmo ap√≥s morrer!
     </div>
     <div class="store-item-price">
      üí∞ R$ 10,00
     </div><button class="buy-btn" id="buyLife1">SOLICITAR COMPRA</button>
     <div style="margin-top: 12px; font-size: 13px; color: #ccc; text-align: center; line-height: 1.5;">
      üìß Enviar email para <strong style="color: #ffd700;">juridicofpolis@gmail.com</strong><br>
       com nome do personagem solicitando este pack
     </div>
    </div>
    <div class="store-item">
     <div class="store-item-title">
      ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è Pack 5 Vidas
     </div>
     <div class="store-item-desc">
      Garanta v√°rias chances de vit√≥ria!
     </div>
     <div class="store-item-price">
      üí∞ R$ 45,00
     </div><button class="buy-btn" id="buyLife5">SOLICITAR COMPRA</button>
     <div style="margin-top: 12px; font-size: 13px; color: #ccc; text-align: center; line-height: 1.5;">
      üìß Enviar email para <strong style="color: #ffd700;">juridicofpolis@gmail.com</strong><br>
       com nome do personagem solicitando este pack
     </div>
    </div><button class="close-store-btn" id="closeStoreBtn">FECHAR LOJA</button>
   </div>
   <div class="admin-panel" id="adminPanel">
    <div class="admin-title">
     üëë PAINEL ADMIN
    </div>
    <div class="admin-section">
     <div class="admin-section-title">
      üìä Estat√≠sticas Gerais
     </div>
     <div style="color: #fff; font-size: 16px;">
      <div style="margin: 10px 0;">
       Total de Jogadores: <span style="color: #00ff88;" id="adminTotalPlayers">0</span>
      </div>
      <div style="margin: 10px 0;">
       Jogadores Vivos: <span style="color: #00ff88;" id="adminAlivePlayers">0</span>
      </div>
     </div>
    </div>
    <div class="admin-section">
     <div class="admin-section-title">
      üë• Gerenciar Jogadores
     </div>
     <div id="adminPlayersList"></div>
    </div><button class="close-admin-btn" id="closeAdminBtn">FECHAR PAINEL</button>
   </div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const GRID_SIZE = 10;
    const GAME_WIDTH = canvas.width;
    const GAME_HEIGHT = canvas.height;
    const UPDATE_INTERVAL = 100;
    const FOOD_COUNT = 30;
    let authMode = 'register';
    
    function getAllPlayers() {
      const players = localStorage.getItem('snake_players');
      return players ? JSON.parse(players) : [];
    }
    function saveAllPlayers(players) {
      localStorage.setItem('snake_players', JSON.stringify(players));
    }
    function getPlayerByName(name) {
      const players = getAllPlayers();
      return players.find(p => p.player_name.toLowerCase() === name.toLowerCase());
    }
    function createPlayer(name, password, email) {
      const existing = getPlayerByName(name);
      if (existing) {
        showError('Este nome j√° est√° em uso! Escolha outro nome.');
        return null;
      }
      const players = getAllPlayers();
      const playerId = generateId();
      const passwordHash = hashPassword(password);
      const startX = Math.floor(Math.random() * (GAME_WIDTH / GRID_SIZE)) * GRID_SIZE;
      const startY = Math.floor(Math.random() * (GAME_HEIGHT / GRID_SIZE)) * GRID_SIZE;
      const playerColor = randomColor();
      const newPlayer = {
        player_id: playerId,
        player_name: name,
        email: email,
        password: passwordHash,
        x: startX,
        y: startY,
        direction: 'right',
        length: 3,
        color: playerColor,
        alive: true,
        score: 0,
        lives: 3,
        total_score: 0,
        last_update: Date.now()
      };
      players.push(newPlayer);
      saveAllPlayers(players);
      return newPlayer;
    }
    function updatePlayer(playerId, updates) {
      const players = getAllPlayers();
      const index = players.findIndex(p => p.player_id === playerId);
      if (index !== -1) {
        players[index] = { ...players[index], ...updates, last_update: Date.now() };
        saveAllPlayers(players);
        return players[index];
      }
      return null;
    }
    function deletePlayer(playerId) {
      const players = getAllPlayers();
      const filtered = players.filter(p => p.player_id !== playerId);
      saveAllPlayers(filtered);
    }
    
    let gameState = {
      myPlayerId: null,
      myPlayer: null,
      myPassword: null,
      players: [],
      foods: [],
      running: false,
      kills: 0,
      lives: 3,
      totalScore: 0
    };

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    function hashPassword(password) {
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(36);
    }
    const COLORS = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd93d', '#6bcf7f', '#a29bfe', '#fd79a8', '#fdcb6e', '#00b894', '#e17055'];
    function randomColor() {
      return COLORS[Math.floor(Math.random() * COLORS.length)];
    }
    function createFood() {
      return {
        x: Math.floor(Math.random() * (GAME_WIDTH / GRID_SIZE)) * GRID_SIZE,
        y: Math.floor(Math.random() * (GAME_HEIGHT / GRID_SIZE)) * GRID_SIZE
      };
    }
    for (let i = 0; i < FOOD_COUNT; i++) {
      gameState.foods.push(createFood());
    }

    function loadOtherPlayers() {
      const allPlayers = getAllPlayers();
      const now = Date.now();
      const PLAYER_INACTIVE_TIME = 10000;
      gameState.players = allPlayers
        .filter(p => p.player_id !== gameState.myPlayerId && (now - p.last_update < PLAYER_INACTIVE_TIME))
        .map(p => ({
          id: p.player_id,
          name: p.player_name,
          x: p.x,
          y: p.y,
          direction: p.direction,
          length: p.length,
          color: p.color,
          alive: p.alive,
          score: p.score,
          segments: generateSegments(p.x, p.y, p.direction, p.length)
        }));
      updateLeaderboard(allPlayers.filter(p => now - p.last_update < PLAYER_INACTIVE_TIME));
      const alivePlayers = allPlayers.filter(p => p.alive && (now - p.last_update < PLAYER_INACTIVE_TIME)).length;
      document.getElementById('playersAlive').textContent = alivePlayers;
    }

    function generateSegments(headX, headY, direction, length) {
      const segments = [{x: headX, y: headY}];
      let x = headX;
      let y = headY;
      const oppositeDir = {
        'up': {dx: 0, dy: GRID_SIZE},
        'down': {dx: 0, dy: -GRID_SIZE},
        'left': {dx: GRID_SIZE, dy: 0},
        'right': {dx: -GRID_SIZE, dy: 0}
      }[direction];
      for (let i = 1; i < length; i++) {
        x += oppositeDir.dx;
        y += oppositeDir.dy;
        segments.push({x, y});
      }
      return segments;
    }

    function updateLivesDisplay() {
      const livesDisplay = document.getElementById('livesDisplay');
      livesDisplay.innerHTML = '';
      for (let i = 0; i < gameState.lives; i++) {
        const heart = document.createElement('span');
        heart.className = 'heart';
        heart.textContent = '‚ù§Ô∏è';
        livesDisplay.appendChild(heart);
      }
    }

    function updatePlayerOnServer() {
      if (!gameState.myPlayer || !gameState.myPlayer.alive) return;
      updatePlayer(gameState.myPlayerId, {
        x: gameState.myPlayer.x,
        y: gameState.myPlayer.y,
        direction: gameState.myPlayer.direction,
        length: gameState.myPlayer.length,
        color: gameState.myPlayer.color,
        score: gameState.myPlayer.score,
        alive: gameState.myPlayer.alive,
        lives: gameState.lives,
        total_score: gameState.totalScore
      });
    }

    function markPlayerDead() {
      if (!gameState.myPlayer) return;
      gameState.myPlayer.alive = false;
      updatePlayer(gameState.myPlayerId, {
        alive: false,
        lives: gameState.lives,
        total_score: gameState.totalScore
      });
    }

    function logoutPlayer() {
      if (!gameState.myPlayer) return;
      gameState.running = false;
      updatePlayer(gameState.myPlayerId, {
        alive: false,
        lives: gameState.lives,
        total_score: gameState.totalScore
      });
      showKillMessage('‚úÖ Progresso salvo com sucesso!');
      setTimeout(() => {
        document.getElementById('nameInputOverlay').style.display = 'flex';
        document.getElementById('nameInput').value = '';
        document.getElementById('passwordInput').value = '';
        gameState.myPlayer = null;
        gameState.myPlayerId = null;
      }, 1500);
    }

    document.addEventListener('keydown', (e) => {
      if (!gameState.running || !gameState.myPlayer || !gameState.myPlayer.alive) return;
      const key = e.key;
      const player = gameState.myPlayer;
      if (key === 'ArrowUp' && player.direction !== 'down') player.nextDirection = 'up';
      else if (key === 'ArrowDown' && player.direction !== 'up') player.nextDirection = 'down';
      else if (key === 'ArrowLeft' && player.direction !== 'right') player.nextDirection = 'left';
      else if (key === 'ArrowRight' && player.direction !== 'left') player.nextDirection = 'right';
    });

    function handleArrowPress(direction) {
      if (!gameState.running || !gameState.myPlayer || !gameState.myPlayer.alive) return;
      const player = gameState.myPlayer;
      if (direction === 'up' && player.direction !== 'down') player.nextDirection = 'up';
      else if (direction === 'down' && player.direction !== 'up') player.nextDirection = 'down';
      else if (direction === 'left' && player.direction !== 'right') player.nextDirection = 'left';
      else if (direction === 'right' && player.direction !== 'left') player.nextDirection = 'right';
    }

    document.getElementById('arrowUp').addEventListener('touchstart', (e) => { e.preventDefault(); handleArrowPress('up'); }, { passive: false });
    document.getElementById('arrowDown').addEventListener('touchstart', (e) => { e.preventDefault(); handleArrowPress('down'); }, { passive: false });
    document.getElementById('arrowLeft').addEventListener('touchstart', (e) => { e.preventDefault(); handleArrowPress('left'); }, { passive: false });
    document.getElementById('arrowRight').addEventListener('touchstart', (e) => { e.preventDefault(); handleArrowPress('right'); }, { passive: false });
    document.getElementById('arrowUp').addEventListener('click', () => handleArrowPress('up'));
    document.getElementById('arrowDown').addEventListener('click', () => handleArrowPress('down'));
    document.getElementById('arrowLeft').addEventListener('click', () => handleArrowPress('left'));
    document.getElementById('arrowRight').addEventListener('click', () => handleArrowPress('right'));

    document.getElementById('logoutBtn').addEventListener('click', () => {
      const confirmOverlay = document.createElement('div');
      confirmOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 5000;';
      const confirmBox = document.createElement('div');
      confirmBox.style.cssText = 'background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; border: 5px solid #fff; text-align: center; max-width: 90%;';
      const confirmText = document.createElement('div');
      confirmText.textContent = 'üö™ SAIR DO JOGO?';
      confirmText.style.cssText = 'font-size: 28px; color: #fff; margin-bottom: 15px; font-weight: bold;';
      const infoText = document.createElement('div');
      infoText.textContent = 'Seu progresso ser√° salvo!';
      infoText.style.cssText = 'font-size: 16px; color: #ddd; margin-bottom: 25px;';
      const confirmBtnContainer = document.createElement('div');
      confirmBtnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;';
      const yesBtn = document.createElement('button');
      yesBtn.textContent = 'SIM, SAIR';
      yesBtn.style.cssText = 'padding: 15px 30px; font-size: 18px; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
      const noBtn = document.createElement('button');
      noBtn.textContent = 'CONTINUAR JOGANDO';
      noBtn.style.cssText = 'padding: 15px 30px; font-size: 18px; background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
      yesBtn.addEventListener('click', () => { document.body.removeChild(confirmOverlay); logoutPlayer(); });
      noBtn.addEventListener('click', () => { document.body.removeChild(confirmOverlay); });
      confirmBtnContainer.appendChild(noBtn);
      confirmBtnContainer.appendChild(yesBtn);
      confirmBox.appendChild(confirmText);
      confirmBox.appendChild(infoText);
      confirmBox.appendChild(confirmBtnContainer);
      confirmOverlay.appendChild(confirmBox);
      document.body.appendChild(confirmOverlay);
    });

    function updateGame() {
      loadOtherPlayers();
      if (!gameState.running || !gameState.myPlayer || !gameState.myPlayer.alive) return;
      const player = gameState.myPlayer;
      player.direction = player.nextDirection;
      let newX = player.x;
      let newY = player.y;
      if (player.direction === 'up') newY -= GRID_SIZE;
      if (player.direction === 'down') newY += GRID_SIZE;
      if (player.direction === 'left') newX -= GRID_SIZE;
      if (player.direction === 'right') newX += GRID_SIZE;
      if (newX < 0) newX = GAME_WIDTH - GRID_SIZE;
      if (newX >= GAME_WIDTH) newX = 0;
      if (newY < 0) newY = GAME_HEIGHT - GRID_SIZE;
      if (newY >= GAME_HEIGHT) newY = 0;
      const hitSelf = player.segments.slice(1).some(seg => seg.x === newX && seg.y === newY);
      if (hitSelf) { gameOver(); return; }
      for (const otherPlayer of gameState.players) {
        if (!otherPlayer.alive) continue;
        const hitOther = otherPlayer.segments.some(seg => seg.x === newX && seg.y === newY);
        if (hitOther) { gameOver(); return; }
      }
      player.x = newX;
      player.y = newY;
      player.segments.unshift({x: newX, y: newY});
      let ateFood = false;
      for (let i = gameState.foods.length - 1; i >= 0; i--) {
        const food = gameState.foods[i];
        if (food.x === newX && food.y === newY) {
          player.length++;
          player.score += 10;
          gameState.totalScore += 10;
          gameState.foods.splice(i, 1);
          gameState.foods.push(createFood());
          ateFood = true;
          updateLivesDisplay();
          break;
        }
      }
      if (!ateFood) player.segments.pop();
      for (let i = gameState.players.length - 1; i >= 0; i--) {
        const otherPlayer = gameState.players[i];
        if (!otherPlayer.alive) continue;
        if (otherPlayer.segments[0].x === newX && otherPlayer.segments[0].y === newY) {
          if (player.length >= otherPlayer.length) {
            player.length += Math.floor(otherPlayer.length / 2);
            player.score += 100;
            gameState.totalScore += 100;
            gameState.kills++;
            player.color = randomColor();
            updateLivesDisplay();
            showKillMessage(`üí• Voc√™ eliminou ${otherPlayer.name}!`);
          }
        }
      }
      document.getElementById('length').textContent = player.length;
      document.getElementById('kills').textContent = gameState.kills;
      document.getElementById('score').textContent = player.score;
      updatePlayerOnServer();
    }

    function render() {
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      gameState.foods.forEach(food => {
        ctx.fillStyle = '#ffd93d';
        ctx.beginPath();
        ctx.arc(food.x + GRID_SIZE/2, food.y + GRID_SIZE/2, GRID_SIZE/2 - 1, 0, Math.PI * 2);
        ctx.fill();
      });
      gameState.players.forEach(player => {
        if (!player.alive) return;
        player.segments.forEach((seg, i) => {
          ctx.fillStyle = i === 0 ? player.color : adjustColor(player.color, -20);
          ctx.fillRect(seg.x + 1, seg.y + 1, GRID_SIZE - 2, GRID_SIZE - 2);
        });
      });
      if (gameState.myPlayer && gameState.myPlayer.alive) {
        const player = gameState.myPlayer;
        player.segments.forEach((seg, i) => {
          ctx.fillStyle = i === 0 ? player.color : adjustColor(player.color, -20);
          ctx.fillRect(seg.x + 1, seg.y + 1, GRID_SIZE - 2, GRID_SIZE - 2);
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
          ctx.lineWidth = 2;
          ctx.strokeRect(seg.x + 1, seg.y + 1, GRID_SIZE - 2, GRID_SIZE - 2);
        });
      }
    }

    function adjustColor(color, amount) {
      const num = parseInt(color.slice(1), 16);
      const r = Math.max(0, Math.min(255, (num >> 16) + amount));
      const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
      const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
      return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    function updateLeaderboard(players) {
      const sorted = [...players].filter(p => p.alive).sort((a, b) => b.score - a.score).slice(0, 10);
      const list = document.getElementById('leaderboardList');
      list.innerHTML = '';
      sorted.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'leaderboard-item' + (player.player_id === gameState.myPlayerId ? ' you' : '');
        const rank = document.createElement('span');
        rank.className = 'rank';
        rank.textContent = `#${index + 1}`;
        const info = document.createElement('div');
        info.className = 'player-info';
        const name = document.createElement('div');
        name.className = 'player-name';
        name.textContent = player.player_name + (player.player_id === gameState.myPlayerId ? ' (VOC√ä)' : '');
        const score = document.createElement('div');
        score.className = 'player-score';
        score.textContent = `${player.score} pts`;
        info.appendChild(name);
        info.appendChild(score);
        item.appendChild(rank);
        item.appendChild(info);
        list.appendChild(item);
        if (player.player_id === gameState.myPlayerId) {
          document.getElementById('rank').textContent = `#${index + 1}`;
        }
      });
    }

    function showKillMessage(message) {
      const killFeed = document.getElementById('killFeed');
      const msg = document.createElement('div');
      msg.className = 'kill-message';
      msg.textContent = message;
      killFeed.appendChild(msg);
      setTimeout(() => { msg.remove(); }, 2000);
    }

    function gameOver() {
      gameState.lives--;
      if (gameState.lives > 0) {
        showKillMessage(`üíÄ MORREU! ‚ù§Ô∏è ${gameState.lives} vidas restantes`);
        updateLivesDisplay();
        const startX = Math.floor(Math.random() * (GAME_WIDTH / GRID_SIZE)) * GRID_SIZE;
        const startY = Math.floor(Math.random() * (GAME_HEIGHT / GRID_SIZE)) * GRID_SIZE;
        gameState.myPlayer.x = startX;
        gameState.myPlayer.y = startY;
        gameState.myPlayer.direction = 'right';
        gameState.myPlayer.nextDirection = 'right';
        gameState.myPlayer.segments = [{x: startX, y: startY}, {x: startX - GRID_SIZE, y: startY}, {x: startX - GRID_SIZE * 2, y: startY}];
        gameState.myPlayer.length = 3;
        gameState.myPlayer.alive = true;
        return;
      }
      gameState.running = false;
      markPlayerDead();
      document.getElementById('finalLength').textContent = gameState.myPlayer.length;
      document.getElementById('finalKills').textContent = gameState.kills;
      document.getElementById('finalScore').textContent = gameState.totalScore;
      document.getElementById('livesRemaining').textContent = gameState.lives;
      const allPlayers = getAllPlayers();
      const sorted = [...allPlayers].sort((a, b) => b.total_score - a.total_score);
      const myRank = sorted.findIndex(p => p.player_id === gameState.myPlayerId) + 1;
      document.getElementById('finalRank').textContent = `#${myRank}`;
      document.getElementById('gameOver').classList.add('show');
    }

    function showError(message) {
      const errorDiv = document.getElementById('authError');
      errorDiv.textContent = '‚ùå ' + message;
      errorDiv.style.display = 'block';
      document.getElementById('authSuccess').style.display = 'none';
      setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('authSuccess');
      successDiv.textContent = '‚úÖ ' + message;
      successDiv.style.display = 'block';
      document.getElementById('authError').style.display = 'none';
      setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
    }

    document.getElementById('loginModeBtn').addEventListener('click', () => {
      if (authMode === 'register') {
        authMode = 'login';
        document.getElementById('authSubtitle').textContent = 'Fa√ßa login com sua conta!';
        document.getElementById('startBtn').textContent = 'FAZER LOGIN';
        document.getElementById('loginModeBtn').textContent = 'CRIAR NOVA CONTA';
      } else {
        authMode = 'register';
        document.getElementById('authSubtitle').textContent = 'Crie sua conta ou fa√ßa login!';
        document.getElementById('startBtn').textContent = 'CRIAR CONTA E JOGAR';
        document.getElementById('loginModeBtn').textContent = 'J√Å TENHO CONTA - FAZER LOGIN';
      }
      document.getElementById('authError').style.display = 'none';
      document.getElementById('authSuccess').style.display = 'none';
    });

    document.getElementById('storeBtn').addEventListener('click', () => {
      document.getElementById('storeModal').classList.add('show');
    });

    document.getElementById('closeStoreBtn').addEventListener('click', () => {
      document.getElementById('storeModal').classList.remove('show');
    });

    document.getElementById('buyLife1').addEventListener('click', () => {
      const playerName = gameState.myPlayer ? gameState.myPlayer.name : 'Jogador';
      const subject = encodeURIComponent('Solicita√ß√£o de Compra - 1 Vida Extra');
      const body = encodeURIComponent(
        `Ol√°,\n\n` +
        `Gostaria de solicitar a compra de 1 VIDA EXTRA no Snake Battle Royale.\n\n` +
        `Detalhes da Compra:\n` +
        `- Produto: 1 Vida Extra ‚ù§Ô∏è\n` +
        `- Valor: R$ 10,00\n` +
        `- Jogador: ${playerName}\n` +
        `- ID do Jogador: ${gameState.myPlayerId || 'N/A'}\n\n` +
        `Aguardo instru√ß√µes para pagamento.\n\n` +
        `Atenciosamente,\n` +
        `${playerName}`
      );
      window.open(`mailto:juridicofpolis@gmail.com?subject=${subject}&body=${body}`, '_blank');
      showKillMessage('üìß Email enviado! Aguarde confirma√ß√£o');
      setTimeout(() => {
        document.getElementById('storeModal').classList.remove('show');
      }, 2000);
    });

    document.getElementById('buyLife5').addEventListener('click', () => {
      const playerName = gameState.myPlayer ? gameState.myPlayer.name : 'Jogador';
      const subject = encodeURIComponent('Solicita√ß√£o de Compra - Pack 5 Vidas');
      const body = encodeURIComponent(
        `Ol√°,\n\n` +
        `Gostaria de solicitar a compra do PACK 5 VIDAS EXTRAS no Snake Battle Royale.\n\n` +
        `Detalhes da Compra:\n` +
        `- Produto: Pack 5 Vidas Extras ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\n` +
        `- Valor: R$ 45,00\n` +
        `- Jogador: ${playerName}\n` +
        `- ID do Jogador: ${gameState.myPlayerId || 'N/A'}\n\n` +
        `Aguardo instru√ß√µes para pagamento.\n\n` +
        `Atenciosamente,\n` +
        `${playerName}`
      );
      window.open(`mailto:juridicofpolis@gmail.com?subject=${subject}&body=${body}`, '_blank');
      showKillMessage('üìß Email enviado! Aguarde confirma√ß√£o');
      setTimeout(() => {
        document.getElementById('storeModal').classList.remove('show');
      }, 2000);
    });

    document.getElementById('adminBtn').addEventListener('click', () => {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 4000;';
      const box = document.createElement('div');
      box.style.cssText = 'background: linear-gradient(135deg, #a29bfe, #6c5ce7); padding: 40px; border-radius: 20px; border: 5px solid #fff; text-align: center;';
      const title = document.createElement('div');
      title.textContent = 'üîê ACESSO ADMIN';
      title.style.cssText = 'font-size: 28px; color: #fff; margin-bottom: 20px; font-weight: bold;';
      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = 'Digite a senha';
      input.style.cssText = 'width: 300px; padding: 15px; font-size: 18px; border: 3px solid #fff; border-radius: 10px; background: rgba(0,0,0,0.5); color: #fff; text-align: center; margin-bottom: 20px; outline: none;';
      const btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'ENTRAR';
      confirmBtn.style.cssText = 'padding: 12px 30px; font-size: 18px; background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCELAR';
      cancelBtn.style.cssText = 'padding: 12px 30px; font-size: 18px; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
      const errorMsg = document.createElement('div');
      errorMsg.style.cssText = 'color: #ff6b6b; font-size: 14px; margin-top: 10px; font-weight: bold; display: none;';
      errorMsg.textContent = '‚ùå Senha incorreta!';
      confirmBtn.addEventListener('click', () => {
        if (input.value === '424398') {
          gameState.isAdmin = true;
          document.body.removeChild(overlay);
          document.getElementById('adminPanel').classList.add('show');
          loadAdminData();
        } else {
          errorMsg.style.display = 'block';
          input.value = '';
          input.focus();
        }
      });
      cancelBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') confirmBtn.click();
      });
      btnContainer.appendChild(confirmBtn);
      btnContainer.appendChild(cancelBtn);
      box.appendChild(title);
      box.appendChild(input);
      box.appendChild(btnContainer);
      box.appendChild(errorMsg);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      setTimeout(() => input.focus(), 100);
    });

    document.getElementById('closeAdminBtn').addEventListener('click', () => {
      document.getElementById('adminPanel').classList.remove('show');
    });

    function loadAdminData() {
      const allPlayers = getAllPlayers();
      const now = Date.now();
      const PLAYER_INACTIVE_TIME = 10000;
      const alivePlayers = allPlayers.filter(p => p.alive && (now - p.last_update < PLAYER_INACTIVE_TIME));
      document.getElementById('adminTotalPlayers').textContent = allPlayers.length;
      document.getElementById('adminAlivePlayers').textContent = alivePlayers.length;
      const playersList = document.getElementById('adminPlayersList');
      playersList.innerHTML = '';
      if (allPlayers.length === 0) {
        playersList.innerHTML = '<div class="no-players-message">Nenhum jogador cadastrado ainda</div>';
      } else {
        const sortedPlayers = [...allPlayers].sort((a, b) => b.total_score - a.total_score);
        sortedPlayers.forEach(player => {
          const item = document.createElement('div');
          item.className = 'admin-player-item';
          const info = document.createElement('div');
          info.className = 'admin-player-info';
          const name = document.createElement('div');
          name.className = 'admin-player-name';
          name.textContent = player.player_name + (player.alive ? ' ‚úÖ' : ' üíÄ');
          const stats = document.createElement('div');
          stats.className = 'admin-player-stats';
          stats.textContent = `üìß ${player.email || 'Sem email'} | Score: ${player.total_score} | Vidas: ${player.lives} | Tamanho: ${player.length}`;
          info.appendChild(name);
          info.appendChild(stats);
          const actions = document.createElement('div');
          actions.className = 'admin-actions';
          const addLifeBtn = document.createElement('button');
          addLifeBtn.className = 'admin-action-btn add-life-btn';
          addLifeBtn.textContent = '+‚ù§Ô∏è';
          addLifeBtn.onclick = () => {
            updatePlayer(player.player_id, { lives: player.lives + 1 });
            showKillMessage(`+1 vida para ${player.player_name}!`);
            loadAdminData();
          };
          const removeLifeBtn = document.createElement('button');
          removeLifeBtn.className = 'admin-action-btn remove-life-btn';
          removeLifeBtn.textContent = '-‚ù§Ô∏è';
          removeLifeBtn.onclick = () => {
            if (player.lives > 0) {
              updatePlayer(player.player_id, { lives: player.lives - 1 });
              showKillMessage(`-1 vida para ${player.player_name}!`);
              loadAdminData();
            }
          };
          const kickBtn = document.createElement('button');
          kickBtn.className = 'admin-action-btn kick-btn';
          kickBtn.textContent = 'EXPULSAR';
          kickBtn.onclick = () => {
            const confirmOverlay = document.createElement('div');
            confirmOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 5000;';
            const confirmBox = document.createElement('div');
            confirmBox.style.cssText = 'background: linear-gradient(135deg, #ff6b6b, #ee5a6f); padding: 30px; border-radius: 20px; border: 5px solid #fff; text-align: center;';
            const confirmText = document.createElement('div');
            confirmText.textContent = `Expulsar ${player.player_name}?`;
            confirmText.style.cssText = 'font-size: 24px; color: #fff; margin-bottom: 20px; font-weight: bold;';
            const confirmBtnContainer = document.createElement('div');
            confirmBtnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
            const yesBtn = document.createElement('button');
            yesBtn.textContent = 'SIM';
            yesBtn.style.cssText = 'padding: 12px 30px; font-size: 18px; background: #fff; color: #ff6b6b; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
            const noBtn = document.createElement('button');
            noBtn.textContent = 'N√ÉO';
            noBtn.style.cssText = 'padding: 12px 30px; font-size: 18px; background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;';
            yesBtn.addEventListener('click', () => {
              deletePlayer(player.player_id);
              document.body.removeChild(confirmOverlay);
              loadAdminData();
            });
            noBtn.addEventListener('click', () => {
              document.body.removeChild(confirmOverlay);
            });
            confirmBtnContainer.appendChild(yesBtn);
            confirmBtnContainer.appendChild(noBtn);
            confirmBox.appendChild(confirmText);
            confirmBox.appendChild(confirmBtnContainer);
            confirmOverlay.appendChild(confirmBox);
            document.body.appendChild(confirmOverlay);
          };
          actions.appendChild(addLifeBtn);
          actions.appendChild(removeLifeBtn);
          actions.appendChild(kickBtn);
          item.appendChild(info);
          item.appendChild(actions);
          playersList.appendChild(item);
        });
      }
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      const name = document.getElementById('nameInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();
      if (!name) { showError('Digite seu nome!'); document.getElementById('nameInput').focus(); return; }
      if (authMode === 'register' && !email) { showError('Digite seu email!'); document.getElementById('emailInput').focus(); return; }
      if (authMode === 'register' && !email.includes('@')) { showError('Email inv√°lido!'); document.getElementById('emailInput').focus(); return; }
      if (!password) { showError('Digite sua senha!'); document.getElementById('passwordInput').focus(); return; }
      if (authMode === 'register') {
        const newPlayer = createPlayer(name, password, email);
        if (!newPlayer) return;
        gameState.myPlayerId = newPlayer.player_id;
        gameState.myPassword = newPlayer.password;
        gameState.kills = 0;
        gameState.lives = 3;
        gameState.totalScore = 0;
        gameState.myPlayer = {
          id: newPlayer.player_id,
          name: newPlayer.player_name,
          email: newPlayer.email,
          x: newPlayer.x,
          y: newPlayer.y,
          direction: 'right',
          nextDirection: 'right',
          segments: [{x: newPlayer.x, y: newPlayer.y}, {x: newPlayer.x - GRID_SIZE, y: newPlayer.y}, {x: newPlayer.x - GRID_SIZE * 2, y: newPlayer.y}],
          length: 3,
          color: newPlayer.color,
          alive: true,
          score: 0
        };
        document.getElementById('playerNameDisplay').textContent = newPlayer.player_name;
        document.getElementById('playerEmailDisplay').textContent = newPlayer.email;
        updateLivesDisplay();
        showSuccess('Conta criada com sucesso!');
      } else {
        const existing = getPlayerByName(name);
        if (!existing) { showError('Jogador n√£o encontrado!'); return; }
        const passwordHash = hashPassword(password);
        if (existing.password !== passwordHash) { showError('Senha incorreta!'); return; }
        gameState.myPlayerId = existing.player_id;
        gameState.myPassword = passwordHash;
        gameState.lives = existing.lives;
        gameState.totalScore = existing.total_score;
        const startX = Math.floor(Math.random() * (GAME_WIDTH / GRID_SIZE)) * GRID_SIZE;
        const startY = Math.floor(Math.random() * (GAME_HEIGHT / GRID_SIZE)) * GRID_SIZE;
        gameState.myPlayer = {
          id: existing.player_id,
          name: existing.player_name,
          email: existing.email,
          x: startX,
          y: startY,
          direction: 'right',
          nextDirection: 'right',
          segments: [{x: startX, y: startY}, {x: startX - GRID_SIZE, y: startY}, {x: startX - GRID_SIZE * 2, y: startY}],
          length: 3,
          color: existing.color,
          alive: true,
          score: 0
        };
        gameState.kills = 0;
        document.getElementById('playerNameDisplay').textContent = existing.player_name;
        document.getElementById('playerEmailDisplay').textContent = existing.email || 'Sem email';
        updatePlayer(existing.player_id, { x: startX, y: startY, direction: 'right', length: 3, alive: true, score: 0 });
        updateLivesDisplay();
        showSuccess('Login realizado!');
      }
      setTimeout(() => {
        document.getElementById('nameInputOverlay').style.display = 'none';
        gameState.running = true;
        setInterval(updateGame, UPDATE_INTERVAL);
        function gameLoop() { render(); if (gameState.running) requestAnimationFrame(gameLoop); }
        gameLoop();
      }, 1000);
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      document.getElementById('gameOver').classList.remove('show');
      if (gameState.lives > 0) {
        const startX = Math.floor(Math.random() * (GAME_WIDTH / GRID_SIZE)) * GRID_SIZE;
        const startY = Math.floor(Math.random() * (GAME_HEIGHT / GRID_SIZE)) * GRID_SIZE;
        gameState.myPlayer.x = startX;
        gameState.myPlayer.y = startY;
        gameState.myPlayer.direction = 'right';
        gameState.myPlayer.nextDirection = 'right';
        gameState.myPlayer.segments = [{x: startX, y: startY}, {x: startX - GRID_SIZE, y: startY}, {x: startX - GRID_SIZE * 2, y: startY}];
        gameState.myPlayer.length = 3;
        gameState.myPlayer.alive = true;
        gameState.myPlayer.score = 0;
        gameState.kills = 0;
        updatePlayer(gameState.myPlayerId, { x: startX, y: startY, direction: 'right', length: 3, alive: true, score: 0, lives: gameState.lives, total_score: gameState.totalScore });
        updateLivesDisplay();
        gameState.running = true;
      } else {
        location.reload();
      }
    });

    window.addEventListener('beforeunload', () => {
      if (gameState.myPlayerId) markPlayerDead();
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a8fee70543cf41e',t:'MTc2NDg5OTgzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
