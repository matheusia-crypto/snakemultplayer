<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Snake Multiplayer</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      box-sizing: border-box;
      height: 100%;
      overflow: hidden;
      touch-action: pan-x pan-y;
    }

    html {
      height: 100%;
    }

    .app-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .screen {
      display: none;
      width: 100%;
      height: 100%;
      flex-direction: column;
    }

    .screen.active {
      display: flex;
    }

    /* Login Screen */
    .login-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px 25px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .logo {
      text-align: center;
      margin-bottom: 25px;
    }

    .logo-emoji {
      font-size: 56px;
      margin-bottom: 10px;
    }

    .app-title-login {
      font-size: 26px;
      font-weight: bold;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
      margin-bottom: 8px;
    }

    .welcome-msg {
      font-size: 13px;
      color: #aaa;
      line-height: 1.4;
    }

    .message-box {
      display: none;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 13px;
    }

    .message-box.show {
      display: block;
    }

    .message-box.error {
      background: rgba(255, 82, 82, 0.2);
      border: 1px solid #ff5252;
      color: #ffcdd2;
    }

    .message-box.success {
      background: rgba(0, 255, 136, 0.2);
      border: 1px solid #00ff88;
      color: #b9ffd9;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      color: #00ff88;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .input-group input {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
    }

    .input-group input:focus {
      outline: none;
      border-color: #00ff88;
      background: rgba(255, 255, 255, 0.12);
    }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #00ff88 0%, #00d4aa 100%);
      border: none;
      border-radius: 12px;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .toggle-text {
      text-align: center;
      font-size: 13px;
      color: #aaa;
      margin-top: 15px;
    }

    .toggle-link {
      color: #00ff88;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
    }

    /* Main Screen */
    .header-bar {
      background: rgba(0, 0, 0, 0.6);
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-color-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .user-name-display {
      font-size: 14px;
      font-weight: bold;
      color: #00ff88;
    }

    .user-role-badge {
      font-size: 10px;
      padding: 3px 8px;
      background: rgba(0, 255, 136, 0.2);
      border-radius: 8px;
      color: #00ff88;
    }

    .user-role-badge.admin {
      background: rgba(255, 82, 82, 0.2);
      color: #ff5252;
    }

    .btn-logout {
      padding: 8px 14px;
      background: rgba(255, 82, 82, 0.3);
      border: 1px solid #ff5252;
      border-radius: 8px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 12px 8px;
      text-align: center;
    }

    .stat-emoji {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .stat-number {
      font-size: 18px;
      font-weight: bold;
      color: #00ff88;
      margin-bottom: 2px;
    }

    .stat-text {
      font-size: 9px;
      color: #aaa;
      text-transform: uppercase;
    }

    .action-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn-action {
      padding: 16px;
      border: none;
      border-radius: 15px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .btn-play {
      background: linear-gradient(135deg, #00ff88 0%, #00d4aa 100%);
      color: #000;
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }

    .btn-solo {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .section-header {
      font-size: 18px;
      font-weight: bold;
      color: #00ff88;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ranking-list {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      overflow: hidden;
    }

    .rank-item {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .rank-item:last-child {
      border-bottom: none;
    }

    .rank-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rank-position {
      font-size: 18px;
      font-weight: bold;
      width: 30px;
    }

    .rank-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #fff;
    }

    .rank-player {
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .rank-score {
      font-size: 16px;
      font-weight: bold;
      color: #00ff88;
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: #00ff88;
      border-radius: 50%;
      display: inline-block;
      margin-left: 5px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .empty-msg {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-emoji {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .admin-section {
      background: rgba(255, 82, 82, 0.1);
      border: 2px solid rgba(255, 82, 82, 0.3);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .admin-user-item {
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-user-item:last-child {
      margin-bottom: 0;
    }

    .admin-user-info {
      flex: 1;
    }

    .admin-user-info strong {
      display: block;
      color: #00ff88;
      margin-bottom: 3px;
      font-size: 13px;
    }

    .admin-user-info small {
      font-size: 11px;
      color: #888;
    }

    .admin-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-life-control {
      padding: 6px 10px;
      background: rgba(0, 255, 136, 0.3);
      border: 1px solid #00ff88;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-life-control:hover {
      background: rgba(0, 255, 136, 0.5);
    }

    .btn-life-control.btn-remove {
      background: rgba(255, 82, 82, 0.3);
      border-color: #ff5252;
    }

    .btn-life-control.btn-remove:hover {
      background: rgba(255, 82, 82, 0.5);
    }

    .btn-reset-pass {
      padding: 6px 10px;
      background: rgba(255, 235, 59, 0.3);
      border: 1px solid #ffeb3b;
      border-radius: 8px;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-reset-pass:hover {
      background: rgba(255, 235, 59, 0.5);
    }

    .btn-delete {
      padding: 6px 12px;
      background: #ff5252;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #ff3838;
    }

    /* Game Screen */
    .game-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;
    }

    .game-top {
      background: rgba(0, 0, 0, 0.9);
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .game-score-display {
      font-size: 18px;
      font-weight: bold;
    }

    .game-score-display span {
      color: #00ff88;
    }

    .btn-exit-game {
      padding: 8px 16px;
      background: #ff5252;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 10px;
      position: relative;
    }

    #canvas {
      border: 3px solid #00ff88;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
      max-width: 100%;
      max-height: 100%;
    }

    .controls-grid {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-template-columns: repeat(3, 65px);
      grid-template-rows: repeat(3, 65px);
      gap: 8px;
    }

    .control-button {
      background: rgba(0, 255, 136, 0.3);
      border: 2px solid #00ff88;
      border-radius: 12px;
      color: #00ff88;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }

    .control-button:active {
      background: rgba(0, 255, 136, 0.5);
    }

    .ctrl-up { grid-column: 2; grid-row: 1; }
    .ctrl-left { grid-column: 1; grid-row: 2; }
    .ctrl-right { grid-column: 3; grid-row: 2; }
    .ctrl-down { grid-column: 2; grid-row: 3; }

    .game-over-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #00ff88;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      min-width: 280px;
      display: none;
    }

    .game-over-modal.show {
      display: block;
    }

    .game-over-title {
      font-size: 32px;
      color: #ff5252;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .game-over-score {
      font-size: 24px;
      color: #00ff88;
      margin-bottom: 20px;
    }

    .game-over-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-restart {
      padding: 14px;
      background: #00ff88;
      border: none;
      border-radius: 12px;
      color: #000;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-menu {
      padding: 14px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .kill-message {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 82, 82, 0.95);
      padding: 15px 25px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      display: none;
    }

    .kill-message.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper"><!-- Login Screen -->
   <div class="screen active" id="screenLogin">
    <div class="login-container">
     <div class="login-card">
      <div class="logo">
       <div class="logo-emoji">
        ÔøΩÔøΩÔøΩÔøΩÔøΩ
       </div>
       <h1 class="app-title-login" id="appTitleLogin">SNAKE MULTIPLAYER</h1>
       <p class="welcome-msg" id="welcomeMsg">Compete com jogadores do mundo todo!</p>
      </div>
      <div class="message-box" id="messageBox"></div>
      <form id="formLogin">
       <div class="input-group"><label for="inputLoginUser">Usu√°rio</label> <input type="text" id="inputLoginUser" placeholder="Seu usu√°rio" required>
       </div>
       <div class="input-group"><label for="inputLoginPass">Senha</label> <input type="password" id="inputLoginPass" placeholder="Sua senha" required>
       </div><button type="submit" class="btn-primary" id="btnLogin">ENTRAR</button>
      </form>
      <form id="formRegister" style="display: none;">
       <div class="input-group"><label for="inputRegUser">Escolha um usu√°rio</label> <input type="text" id="inputRegUser" placeholder="M√≠nimo 3 caracteres" required minlength="3">
       </div>
       <div class="input-group"><label for="inputRegEmail">Seu e-mail</label> <input type="email" id="inputRegEmail" placeholder="seu@email.com" required>
       </div>
       <div class="input-group"><label for="inputRegPass">Escolha uma senha</label> <input type="password" id="inputRegPass" placeholder="M√≠nimo 4 caracteres" required minlength="4">
       </div><button type="submit" class="btn-primary" id="btnRegister">CRIAR CONTA</button>
      </form>
      <div class="toggle-text"><span id="toggleQuestion">N√£o tem conta?</span> <a class="toggle-link" id="toggleFormLink">Criar conta</a>
      </div>
     </div>
    </div>
   </div><!-- Main Screen -->
   <div class="screen" id="screenMain">
    <div class="header-bar">
     <div class="user-badge">
      <div class="user-color-indicator" id="userColorIndicator"></div>
      <div>
       <div class="user-name-display" id="userNameDisplay"></div>
       <div class="user-role-badge" id="userRoleBadge"></div>
      </div>
     </div><button type="button" class="btn-logout" id="btnLogout">Sair</button>
    </div>
    <div class="main-content">
     <div class="stats-row">
      <div class="stat-box">
       <div class="stat-emoji">
        üèÜ
       </div>
       <div class="stat-number" id="statMyScore">
        0
       </div>
       <div class="stat-text">
        Score
       </div>
      </div>
      <div class="stat-box">
       <div class="stat-emoji">
        ‚ù§Ô∏è
       </div>
       <div class="stat-number" id="statLives">
        3
       </div>
       <div class="stat-text">
        Vidas
       </div>
      </div>
      <div class="stat-box">
       <div class="stat-emoji">
        üíÄ
       </div>
       <div class="stat-number" id="statKills">
        0
       </div>
       <div class="stat-text">
        Kills
       </div>
      </div>
      <div class="stat-box">
       <div class="stat-emoji">
        üë•
       </div>
       <div class="stat-number" id="statOnline">
        0
       </div>
       <div class="stat-text">
        Online
       </div>
      </div>
      <div class="stat-box">
       <div class="stat-emoji">
        ÔøΩÔøΩ
       </div>
       <div class="stat-number" id="statTotal">
        0
       </div>
       <div class="stat-text">
        Total
       </div>
      </div>
     </div>
     <div id="adminSection" class="admin-section" style="display: none;">
      <h3 class="section-header">üõ°Ô∏è Painel Admin</h3>
      <div id="adminUsersList"></div>
     </div>
     <div class="action-row"><button type="button" class="btn-action btn-play" id="btnPlay"> <span style="font-size: 24px;">üåç</span> <span id="btnPlayText">JOGAR AGORA</span> </button> <button type="button" class="btn-action btn-solo" id="btnSolo"> <span style="font-size: 24px;">‚ö°</span> <span id="btnSoloText">MODO SOLO</span> </button>
     </div>
     <h3 class="section-header">üèÖ Ranking Global</h3>
     <div class="ranking-list" id="rankingList"></div>
    </div>
   </div><!-- Game Screen -->
   <div class="screen" id="screenGame">
    <div class="game-container">
     <div class="game-top">
      <div class="game-score-display">
       Score: <span id="currentScore">0</span> | ‚ù§Ô∏è <span id="currentLives">3</span>
      </div><button type="button" class="btn-exit-game" id="btnExitGame">Sair</button>
     </div>
     <div class="game-area">
      <div class="kill-message" id="killMessage"></div>
      <canvas id="canvas" width="300" height="300"></canvas>
      <div class="controls-grid"><button type="button" class="control-button ctrl-up" id="ctrlUp">ÔøΩÔøΩ</button> <button type="button" class="control-button ctrl-left" id="ctrlLeft">‚óÑ</button> <button type="button" class="control-button ctrl-right" id="ctrlRight">‚ñ∫</button> <button type="button" class="control-button ctrl-down" id="ctrlDown">ÔøΩÔøΩÔøΩ</button>
      </div>
      <div class="game-over-modal" id="gameOverModal">
       <div class="game-over-title">
        GAME OVER!
       </div>
       <div class="game-over-score">
        Score: <span id="finalScore">0</span>
       </div>
       <div class="game-over-buttons"><button type="button" class="btn-restart" id="btnRestart">Jogar Novamente</button> <button type="button" class="btn-menu" id="btnBackMenu">Voltar ao Menu</button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "SNAKE MULTIPLAYER",
      welcome_message: "Compete com jogadores do mundo todo!",
      login_btn_text: "ENTRAR",
      register_btn_text: "CRIAR CONTA",
      play_btn_text: "JOGAR AGORA",
      solo_btn_text: "MODO SOLO"
    };

    // Paleta de cores √∫nicas para snakes
    const SNAKE_COLORS = [
      '#00ff88', '#ff5252', '#ffeb3b', '#00bcd4', 
      '#e91e63', '#9c27b0', '#ff9800', '#4caf50',
      '#f44336', '#2196f3', '#ffc107', '#8bc34a',
      '#ff6f00', '#00e676', '#ff1744', '#00e5ff'
    ];

    let currentUser = null;
    let allUsers = [];
    let isLoginForm = true;
    let isSoloMode = false;

    // Game Variables
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cellSize = 15;
    const gridWidth = canvas.width / cellSize;
    const gridHeight = canvas.height / cellSize;

    let snake = { x: 10, y: 10, dx: 1, dy: 0, body: [], length: 5 };
    let apple = { x: 15, y: 15 };
    let hearts = [];
    let score = 0;
    let lives = 3;
    let lastLifeScore = 0;
    let gameInterval = null;
    let isPlaying = false;
    let otherSnakes = [];
    let currentSnakeColor = '#00ff88';

    // Data SDK
    const dataHandler = {
      onDataChanged(data) {
        allUsers = data.filter(d => d.username);
        if (currentUser) {
          const updated = allUsers.find(u => u.user_id === currentUser.user_id);
          if (updated) currentUser = updated;
        }
        refreshUI();
        updateOtherSnakes();
      }
    };

    async function initializeApp() {
      showMsg('Carregando...', 'success');
      const result = await window.dataSdk.init(dataHandler);
      
      if (result.isError) {
        showMsg('Erro ao conectar: ' + result.error.message, 'error');
      } else {
        hideMsg();
      }
    }

    function getAvailableColor() {
      const usedColors = allUsers.map(u => u.snake_color).filter(c => c);
      for (let color of SNAKE_COLORS) {
        if (!usedColors.includes(color)) {
          return color;
        }
      }
      return SNAKE_COLORS[Math.floor(Math.random() * SNAKE_COLORS.length)];
    }

    async function registerUser(username, email, password) {
      try {
        if (!window.dataSdk) {
          showMsg('Sistema n√£o carregado. Recarregue a p√°gina.', 'error');
          return false;
        }

        if (allUsers.length >= 999) {
          showMsg('Limite de 999 usu√°rios atingido', 'error');
          return false;
        }

        const exists = allUsers.find(u => u.username === username);
        if (exists) {
          showMsg('Este usu√°rio j√° existe', 'error');
          return false;
        }

        const emailExists = allUsers.find(u => u.email === email);
        if (emailExists) {
          showMsg('Este e-mail j√° est√° cadastrado', 'error');
          return false;
        }

        const newUser = {
          user_id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          username: username,
          email: email,
          password: password,
          role: allUsers.length === 0 ? 'admin' : 'player',
          score: 0,
          lives: 3,
          kills: 0,
          snake_color: getAvailableColor(),
          is_online: false,
          last_active: new Date().toISOString(),
          created_at: new Date().toISOString()
        };

        showMsg('Criando conta...', 'success');
        const result = await window.dataSdk.create(newUser);

        if (result.isOk) {
          showMsg('Conta criada! Fa√ßa login.', 'success');
          setTimeout(() => switchForm(), 1000);
          return true;
        } else {
          showMsg('Erro: ' + (result.error.message || 'Falha ao criar'), 'error');
          return false;
        }
      } catch (error) {
        showMsg('Erro inesperado: ' + error.message, 'error');
        return false;
      }
    }

    async function loginUser(username, password) {
      const user = allUsers.find(u => u.username === username && u.password === password);
      
      if (user) {
        currentUser = user;
        currentUser.is_online = true;
        currentUser.last_active = new Date().toISOString();
        
        if (!currentUser.snake_color) {
          currentUser.snake_color = getAvailableColor();
        }
        
        await window.dataSdk.update(currentUser);
        
        switchScreen('screenMain');
        refreshUI();
        return true;
      } else {
        showMsg('Usu√°rio ou senha incorretos', 'error');
        return false;
      }
    }

    async function logoutUser() {
      if (currentUser) {
        currentUser.is_online = false;
        currentUser.last_active = new Date().toISOString();
        await window.dataSdk.update(currentUser);
      }
      currentUser = null;
      switchScreen('screenLogin');
    }

    async function deleteUserAdmin(user) {
      const result = await window.dataSdk.delete(user);
      if (result.isError) {
        showMsg('Erro ao deletar usu√°rio', 'error');
      }
    }

    function switchScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showMsg(text, type) {
      const box = document.getElementById('messageBox');
      box.textContent = text;
      box.className = `message-box ${type} show`;
    }

    function hideMsg() {
      document.getElementById('messageBox').classList.remove('show');
    }

    function switchForm() {
      isLoginForm = !isLoginForm;
      document.getElementById('formLogin').style.display = isLoginForm ? 'block' : 'none';
      document.getElementById('formRegister').style.display = isLoginForm ? 'none' : 'block';
      document.getElementById('toggleQuestion').textContent = isLoginForm ? 'N√£o tem conta?' : 'J√° tem conta?';
      document.getElementById('toggleFormLink').textContent = isLoginForm ? 'Criar conta' : 'Fazer login';
      hideMsg();
    }

    function refreshUI() {
      if (!currentUser) return;

      document.getElementById('userNameDisplay').textContent = currentUser.username;
      document.getElementById('userRoleBadge').textContent = currentUser.role.toUpperCase();
      document.getElementById('userRoleBadge').classList.toggle('admin', currentUser.role === 'admin');
      
      const colorIndicator = document.getElementById('userColorIndicator');
      if (colorIndicator) {
        colorIndicator.style.backgroundColor = currentUser.snake_color || '#00ff88';
      }

      document.getElementById('statMyScore').textContent = currentUser.score || 0;
      document.getElementById('statLives').textContent = currentUser.lives || 3;
      document.getElementById('statKills').textContent = currentUser.kills || 0;
      
      const onlineUsers = allUsers.filter(u => u.is_online);
      document.getElementById('statOnline').textContent = onlineUsers.length;
      document.getElementById('statTotal').textContent = allUsers.length;

      if (currentUser.role === 'admin') {
        document.getElementById('adminSection').style.display = 'block';
        renderAdminPanel();
      } else {
        document.getElementById('adminSection').style.display = 'none';
      }

      renderRanking();
    }

    function renderAdminPanel() {
      const container = document.getElementById('adminUsersList');
      container.innerHTML = '';

      allUsers.forEach(user => {
        const div = document.createElement('div');
        div.className = 'admin-user-item';
        div.innerHTML = `
          <div class="admin-user-info">
            <strong>${user.username}</strong>
            <small>üìß ${user.email || 'Sem email'} | Role: ${user.role} | Score: ${user.score} | ‚ù§Ô∏è ${user.lives || 3} | Kills: ${user.kills || 0} | ${user.is_online ? 'üü¢ Online' : '‚ö´ Offline'}</small>
          </div>
          <div class="admin-controls">
            <button type="button" class="btn-life-control" onclick="addLifeAdmin('${user.user_id}')">‚ù§Ô∏è+</button>
            <button type="button" class="btn-life-control btn-remove" onclick="removeLifeAdmin('${user.user_id}')">‚ù§Ô∏è-</button>
            <button type="button" class="btn-reset-pass" onclick="resetPasswordAdmin('${user.user_id}')">üîë</button>
            ${currentUser.user_id !== user.user_id ? `<button type="button" class="btn-delete" onclick="deleteUserAdmin(allUsers.find(u => u.user_id === '${user.user_id}'))">Deletar</button>` : ''}
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function addLifeAdmin(userId) {
      const user = allUsers.find(u => u.user_id === userId);
      if (!user) return;
      
      user.lives = (user.lives || 3) + 1;
      const result = await window.dataSdk.update(user);
      
      if (result.isError) {
        showMsg('Erro ao adicionar vida', 'error');
      }
    }

    async function removeLifeAdmin(userId) {
      const user = allUsers.find(u => u.user_id === userId);
      if (!user) return;
      
      user.lives = Math.max(0, (user.lives || 3) - 1);
      const result = await window.dataSdk.update(user);
      
      if (result.isError) {
        showMsg('Erro ao remover vida', 'error');
      }
    }

    async function resetPasswordAdmin(userId) {
      const user = allUsers.find(u => u.user_id === userId);
      if (!user) return;
      
      const newPassword = '1234';
      user.password = newPassword;
      
      const result = await window.dataSdk.update(user);
      
      if (result.isOk) {
        showMsg(`üîë Senha de ${user.username} resetada para: 1234`, 'success');
        setTimeout(() => hideMsg(), 5000);
      } else {
        showMsg('Erro ao resetar senha', 'error');
      }
    }

    function renderRanking() {
      const container = document.getElementById('rankingList');
      container.innerHTML = '';

      if (allUsers.length === 0) {
        container.innerHTML = '<div class="empty-msg"><div class="empty-emoji">üèÜ</div><p>Nenhum jogador ainda</p></div>';
        return;
      }

      const sorted = [...allUsers].sort((a, b) => (b.score || 0) - (a.score || 0));
      const medals = ['ü•á', 'ü•à', 'ü•â'];

      sorted.forEach((user, index) => {
        const div = document.createElement('div');
        div.className = 'rank-item';
        const colorDot = `<span class="rank-color-dot" style="background-color: ${user.snake_color || '#00ff88'}"></span>`;
        div.innerHTML = `
          <div class="rank-left">
            <div class="rank-position">${index < 3 ? medals[index] : `${index + 1}¬∫`}</div>
            ${colorDot}
            <div class="rank-player">
              <div style="font-weight: 600;">${user.username}</div>
              <div style="font-size: 11px; color: #888; margin-top: 2px;">üìß ${user.email || 'Sem email'}</div>
              ${user.is_online ? '<span class="online-dot"></span>' : ''}
            </div>
          </div>
          <div class="rank-score">${user.score || 0}</div>
        `;
        container.appendChild(div);
      });
    }

    function updateOtherSnakes() {
      if (!isPlaying || isSoloMode) return;
      
      const onlineUsers = allUsers.filter(u => 
        u.is_online && 
        u.user_id !== currentUser.user_id
      );

      otherSnakes = onlineUsers.map(user => ({
        userId: user.user_id,
        username: user.username,
        color: user.snake_color || '#ff5252',
        x: Math.floor(Math.random() * gridWidth),
        y: Math.floor(Math.random() * gridHeight),
        dx: [1, -1, 0, 0][Math.floor(Math.random() * 4)],
        dy: [0, 0, 1, -1][Math.floor(Math.random() * 4)],
        body: [],
        length: 5 + Math.floor(Math.random() * 10)
      }));
    }

    // Game Functions
    function startGame(solo = false) {
      isSoloMode = solo;
      switchScreen('screenGame');
      isPlaying = true;
      score = 0;
      lives = currentUser ? (currentUser.lives || 3) : 3;
      lastLifeScore = 0;
      snake = { x: 10, y: 10, dx: 1, dy: 0, body: [], length: 5 };
      apple = { x: 15, y: 15 };
      hearts = [];
      currentSnakeColor = currentUser ? currentUser.snake_color : '#00ff88';
      
      document.getElementById('currentScore').textContent = score;
      document.getElementById('currentLives').textContent = lives;
      document.getElementById('gameOverModal').classList.remove('show');

      if (!solo) {
        updateOtherSnakes();
      } else {
        otherSnakes = [];
      }

      if (gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, 100);
    }

    function moveOtherSnakes() {
      otherSnakes.forEach(enemySnake => {
        if (Math.random() < 0.1) {
          const directions = [
            {dx: 1, dy: 0}, {dx: -1, dy: 0},
            {dx: 0, dy: 1}, {dx: 0, dy: -1}
          ];
          const dir = directions[Math.floor(Math.random() * 4)];
          if (!(enemySnake.dx === -dir.dx && enemySnake.dy === -dir.dy)) {
            enemySnake.dx = dir.dx;
            enemySnake.dy = dir.dy;
          }
        }

        enemySnake.x += enemySnake.dx;
        enemySnake.y += enemySnake.dy;

        if (enemySnake.x < 0) enemySnake.x = gridWidth - 1;
        if (enemySnake.x >= gridWidth) enemySnake.x = 0;
        if (enemySnake.y < 0) enemySnake.y = gridHeight - 1;
        if (enemySnake.y >= gridHeight) enemySnake.y = 0;

        enemySnake.body.push({ x: enemySnake.x, y: enemySnake.y });
        while (enemySnake.body.length > enemySnake.length) {
          enemySnake.body.shift();
        }
      });
    }

    function checkCollisionWithOtherSnakes() {
      for (let enemySnake of otherSnakes) {
        if (snake.x === enemySnake.x && snake.y === enemySnake.y) {
          showKillMessage(`üíÄ Voc√™ eliminou ${enemySnake.username}!`);
          currentSnakeColor = enemySnake.color;
          if (currentUser) {
            currentUser.snake_color = enemySnake.color;
            currentUser.kills = (currentUser.kills || 0) + 1;
          }
          score += 50;
          document.getElementById('currentScore').textContent = score;
          
          // Dropar 3 cora√ß√µes se a snake tinha mais de 1000 pontos
          if (enemySnake.length > 100) {
            for (let i = 0; i < 3; i++) {
              hearts.push({
                x: Math.floor(Math.random() * gridWidth),
                y: Math.floor(Math.random() * gridHeight)
              });
            }
            showKillMessage(`üíÄ Voc√™ eliminou ${enemySnake.username}! +3 ‚ù§Ô∏è dropados!`);
          }
          
          otherSnakes = otherSnakes.filter(s => s.userId !== enemySnake.userId);
          return;
        }

        for (let segment of enemySnake.body) {
          if (snake.x === segment.x && snake.y === segment.y) {
            lives--;
            document.getElementById('currentLives').textContent = lives;
            
            if (lives <= 0) {
              endGame(true, enemySnake.username);
            } else {
              showKillMessage(`ÔøΩÔøΩÔøΩÔøΩÔøΩ ${enemySnake.username} te acertou! Restam ${lives} vidas`);
              snake = { x: 10, y: 10, dx: 1, dy: 0, body: [], length: 5 };
            }
            return;
          }
        }

        for (let segment of snake.body) {
          if (enemySnake.x === segment.x && enemySnake.y === segment.y) {
            showKillMessage(`üíÄ Voc√™ eliminou ${enemySnake.username}!`);
            currentSnakeColor = enemySnake.color;
            if (currentUser) {
              currentUser.snake_color = enemySnake.color;
              currentUser.kills = (currentUser.kills || 0) + 1;
            }
            score += 50;
            document.getElementById('currentScore').textContent = score;
            otherSnakes = otherSnakes.filter(s => s.userId !== enemySnake.userId);
            return;
          }
        }
      }
    }

    function showKillMessage(message) {
      const killMsg = document.getElementById('killMessage');
      killMsg.textContent = message;
      killMsg.classList.add('show');
      
      setTimeout(() => {
        killMsg.classList.remove('show');
      }, 2000);
    }

    function gameLoop() {
      if (!isPlaying) return;

      snake.x += snake.dx;
      snake.y += snake.dy;

      if (snake.x < 0) snake.x = gridWidth - 1;
      if (snake.x >= gridWidth) snake.x = 0;
      if (snake.y < 0) snake.y = gridHeight - 1;
      if (snake.y >= gridHeight) snake.y = 0;

      snake.body.push({ x: snake.x, y: snake.y });
      while (snake.body.length > snake.length) {
        snake.body.shift();
      }

      for (let i = 0; i < snake.body.length - 1; i++) {
        if (snake.body[i].x === snake.x && snake.body[i].y === snake.y) {
          loseLife();
          return;
        }
      }

      if (snake.x === apple.x && snake.y === apple.y) {
        snake.length++;
        score += 10;
        document.getElementById('currentScore').textContent = score;
        
        if (Math.floor(score / 500) > Math.floor(lastLifeScore / 500)) {
          lives++;
          document.getElementById('currentLives').textContent = lives;
          showKillMessage('‚ù§Ô∏è +1 VIDA! (500 pontos)');
        }
        lastLifeScore = score;
        
        apple.x = Math.floor(Math.random() * gridWidth);
        apple.y = Math.floor(Math.random() * gridHeight);
      }

      // Checar colis√£o com cora√ß√µes
      for (let i = hearts.length - 1; i >= 0; i--) {
        if (snake.x === hearts[i].x && snake.y === hearts[i].y) {
          lives++;
          document.getElementById('currentLives').textContent = lives;
          showKillMessage('‚ù§Ô∏è +1 VIDA coletada!');
          hearts.splice(i, 1);
        }
      }

      if (!isSoloMode) {
        moveOtherSnakes();
        checkCollisionWithOtherSnakes();
      }

      drawGame();
    }

    function drawGame() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= gridWidth; i++) {
        ctx.beginPath();
        ctx.moveTo(i * cellSize, 0);
        ctx.lineTo(i * cellSize, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i <= gridHeight; i++) {
        ctx.beginPath();
        ctx.moveTo(0, i * cellSize);
        ctx.lineTo(canvas.width, i * cellSize);
        ctx.stroke();
      }

      ctx.fillStyle = '#ff5252';
      ctx.fillRect(apple.x * cellSize + 1, apple.y * cellSize + 1, cellSize - 2, cellSize - 2);

      // Desenhar cora√ß√µes
      hearts.forEach(heart => {
        ctx.fillStyle = '#ff69b4';
        ctx.beginPath();
        const centerX = heart.x * cellSize + cellSize / 2;
        const centerY = heart.y * cellSize + cellSize / 2;
        const size = cellSize / 3;
        
        // Desenhar cora√ß√£o simplificado
        ctx.arc(centerX - size / 2, centerY - size / 2, size / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(centerX + size / 2, centerY - size / 2, size / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(centerX - size, centerY - size / 2);
        ctx.lineTo(centerX, centerY + size);
        ctx.lineTo(centerX + size, centerY - size / 2);
        ctx.fill();
      });

      otherSnakes.forEach(enemySnake => {
        enemySnake.body.forEach((segment, index) => {
          ctx.globalAlpha = (index + 1) / enemySnake.body.length;
          ctx.fillStyle = enemySnake.color;
          ctx.fillRect(segment.x * cellSize + 1, segment.y * cellSize + 1, cellSize - 2, cellSize - 2);
        });
      });
      ctx.globalAlpha = 1;

      snake.body.forEach((segment, index) => {
        ctx.globalAlpha = (index + 1) / snake.body.length;
        ctx.fillStyle = currentSnakeColor;
        ctx.fillRect(segment.x * cellSize + 1, segment.y * cellSize + 1, cellSize - 2, cellSize - 2);
      });
      ctx.globalAlpha = 1;
    }

    function loseLife() {
      lives--;
      document.getElementById('currentLives').textContent = lives;
      
      if (lives <= 0) {
        endGame(false);
      } else {
        showKillMessage(`üíî Perdeu 1 vida! Restam ${lives}`);
        snake = { x: 10, y: 10, dx: 1, dy: 0, body: [], length: 5 };
      }
    }

    async function endGame(killedByOther = false, killerName = '') {
      isPlaying = false;
      clearInterval(gameInterval);

      if (!isSoloMode && currentUser) {
        if (score > (currentUser.score || 0)) {
          currentUser.score = score;
        }
        currentUser.lives = lives > 0 ? lives : 3;
        await window.dataSdk.update(currentUser);
      }

      const title = document.querySelector('.game-over-title');
      if (killedByOther) {
        title.textContent = `üíÄ ${killerName} TE ELIMINOU!`;
      } else {
        title.textContent = 'GAME OVER!';
      }

      document.getElementById('finalScore').textContent = score;
      document.getElementById('gameOverModal').classList.add('show');
    }

    function exitGame() {
      isPlaying = false;
      clearInterval(gameInterval);
      document.getElementById('gameOverModal').classList.remove('show');
      switchScreen('screenMain');
    }

    function changeDir(dx, dy) {
      if (snake.dx === -dx && snake.dy === -dy) return;
      snake.dx = dx;
      snake.dy = dy;
    }

    document.getElementById('formLogin').addEventListener('submit', (e) => {
      e.preventDefault();
      const user = document.getElementById('inputLoginUser').value;
      const pass = document.getElementById('inputLoginPass').value;
      loginUser(user, pass);
    });

    document.getElementById('formRegister').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = document.getElementById('inputRegUser').value;
      const email = document.getElementById('inputRegEmail').value;
      const pass = document.getElementById('inputRegPass').value;
      await registerUser(user, email, pass);
    });

    document.getElementById('toggleFormLink').addEventListener('click', switchForm);
    document.getElementById('btnLogout').addEventListener('click', logoutUser);
    document.getElementById('btnPlay').addEventListener('click', () => startGame(false));
    document.getElementById('btnSolo').addEventListener('click', () => startGame(true));
    document.getElementById('btnExitGame').addEventListener('click', exitGame);
    document.getElementById('btnRestart').addEventListener('click', () => startGame(isSoloMode));
    document.getElementById('btnBackMenu').addEventListener('click', exitGame);

    document.addEventListener('keydown', (e) => {
      if (!isPlaying) return;
      if (e.key === 'ArrowUp' || e.key === 'w') changeDir(0, -1);
      if (e.key === 'ArrowDown' || e.key === 's') changeDir(0, 1);
      if (e.key === 'ArrowLeft' || e.key === 'a') changeDir(-1, 0);
      if (e.key === 'ArrowRight' || e.key === 'd') changeDir(1, 0);
    });

    document.getElementById('ctrlUp').addEventListener('click', () => changeDir(0, -1));
    document.getElementById('ctrlDown').addEventListener('click', () => changeDir(0, 1));
    document.getElementById('ctrlLeft').addEventListener('click', () => changeDir(-1, 0));
    document.getElementById('ctrlRight').addEventListener('click', () => changeDir(1, 0));

    async function onConfigChange(config) {
      const title = document.getElementById('appTitleLogin');
      if (title) title.textContent = config.app_title || defaultConfig.app_title;

      const welcome = document.getElementById('welcomeMsg');
      if (welcome) welcome.textContent = config.welcome_message || defaultConfig.welcome_message;

      const loginBtn = document.getElementById('btnLogin');
      if (loginBtn) loginBtn.textContent = config.login_btn_text || defaultConfig.login_btn_text;

      const regBtn = document.getElementById('btnRegister');
      if (regBtn) regBtn.textContent = config.register_btn_text || defaultConfig.register_btn_text;

      const playBtn = document.getElementById('btnPlayText');
      if (playBtn) playBtn.textContent = config.play_btn_text || defaultConfig.play_btn_text;

      const soloBtn = document.getElementById('btnSoloText');
      if (soloBtn) soloBtn.textContent = config.solo_btn_text || defaultConfig.solo_btn_text;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
        ["login_btn_text", config.login_btn_text || defaultConfig.login_btn_text],
        ["register_btn_text", config.register_btn_text || defaultConfig.register_btn_text],
        ["play_btn_text", config.play_btn_text || defaultConfig.play_btn_text],
        ["solo_btn_text", config.solo_btn_text || defaultConfig.solo_btn_text]
      ]);
    }

    // Inicializa√ß√£o dos SDKs
    (function initializeSdks() {
      let attempts = 0;
      const maxAttempts = 100;
      
      const tryInit = async () => {
        attempts++;
        
        // Tentar inicializar Element SDK
        if (window.elementSdk && !window.elementSdkInitialized) {
          try {
            window.elementSdk.init({
              defaultConfig,
              onConfigChange,
              mapToCapabilities,
              mapToEditPanelValues
            });
            window.elementSdkInitialized = true;
          } catch (e) {
            console.error('Element SDK error:', e);
          }
        }
        
        // Tentar inicializar Data SDK
        if (window.dataSdk && !window.dataSdkInitialized) {
          try {
            await initializeApp();
            window.dataSdkInitialized = true;
            return; // Sucesso! Parar tentativas
          } catch (e) {
            console.error('Data SDK error:', e);
          }
        }
        
        // Se ainda n√£o inicializou e n√£o atingiu o limite, tentar novamente
        if (!window.dataSdkInitialized && attempts < maxAttempts) {
          setTimeout(tryInit, 50);
        } else if (attempts >= maxAttempts) {
          showMsg('‚ö†Ô∏è Erro ao carregar. Recarregue a p√°gina.', 'error');
        }
      };
      
      // Iniciar tentativas
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryInit);
      } else {
        tryInit();
      }
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a94acdeb05c6497',t:'MTc2NDk0OTU3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
